<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processando login Google...</title>
  <link rel="icon" type="image/svg+xml" href="../assets/icone_verde.svg">
  <style>
    body { display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; font-family:Inter, sans-serif; background:#f5f5f5; }
    .loading { text-align:center; padding:2rem; }
    .spinner { border:4px solid #f3f3f3; border-top:4px solid #4CAF50; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 1rem; }
    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div class="loading">
    <div class="spinner"></div>
    <p>Processando login com Google...</p>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    // --- ajuste suas keys aqui se precisar ---
    const SUPABASE_URL = "https://omvwicetojhqurdeuequ.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tdndpY2V0b2pocXVyZGV1ZXF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTI5MTEsImV4cCI6MjA3ODk4ODkxMX0.3XyOux7wjBIC2kIlmdSCTYzznzZOk5tJcHJJMA3Jggc";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function processCallback() {
      try {
        console.log('[callbackGoogleLogin] Processando callback do OAuth...');

        // tenta processar token do hash da URL (caso necessário)
        if (typeof supabase.auth.getSessionFromUrl === 'function') {
          try {
            await supabase.auth.getSessionFromUrl({ storeSession: true });
          } catch (e) {
            console.warn('[callbackGoogleLogin] getSessionFromUrl falhou (seguindo):', e?.message || e);
          }
        }

        const { data, error } = await supabase.auth.getSession();
        const session = data?.session ?? null;
        const user = session?.user ?? null;
        console.log('[callbackGoogleLogin] getSession raw data:', data);

        if (error || !user || !session) {
          console.error('[callbackGoogleLogin] Sessão inválida:', error);
          alert('Não foi possível completar o login com Google. Tente novamente.');
          window.location.href = '../index.html';
          return;
        }

        // Prepara dados a enviar ao backend
        const payload = {
          email: user.email,
          nome: user.user_metadata?.full_name || (user.email ? user.email.split('@')[0] : ''),
          foto_url: user.user_metadata?.avatar_url || null,
          auth_uid: user.id || null,
          access_token: session.access_token || null,
          refresh_token: session.refresh_token || null
        };

        const API_URL = window.API_CONFIG?.AUTH || "/api/authe";
        const fullUrl = `${API_URL}/google-login`;
        console.log('[callbackGoogleLogin] Chamando API:', fullUrl, payload);

        // Envia também no header Authorization (compatibilidade)
        const headers = {
          "Content-Type": "application/json"
        };
        if (session.access_token) headers.Authorization = `Bearer ${session.access_token}`;

        const resp = await fetch(fullUrl, {
          method: "POST",
          headers,
          body: JSON.stringify(payload)
        });

        console.log('[callbackGoogleLogin] Resposta da API:', resp.status, resp.statusText);

        if (!resp.ok) {
          let errorText = '';
          try { const j = await resp.json(); errorText = JSON.stringify(j); }
          catch (e) { try { errorText = await resp.text(); } catch (t) { errorText = `Status ${resp.status}`; } }
          console.error('[callbackGoogleLogin] Erro da API (detalhe):', errorText);
          alert('Erro no servidor: ' + (errorText || resp.statusText));
          window.location.href = '../index.html';
          return;
        }

        const result = await resp.json();
        console.log('[callbackGoogleLogin] Resultado:', result);

        if (result.user) {
          const backendUser = {
            id: result.user.usuario_id || result.user.id,
            usuario_id: result.user.usuario_id || result.user.id,
            nome: result.user.nome || payload.nome,
            email: user.email,
            telefone: result.user.telefone || null,
            tipo: result.user.tipo || 'cliente',
            photoURL: payload.foto_url,
            primeiroNome: (result.user.nome || payload.nome).split(' ')[0],
            auth_uid: user.id,
            loginGoogle: true
          };

          // salva token (backend ou supabase)
          if (result.accessToken || result.access_token) {
            localStorage.setItem('cuidafast_token', result.accessToken || result.access_token);
          } else if (session.access_token) {
            localStorage.setItem('cuidafast_token', session.access_token);
          }

          localStorage.setItem('cuidafast_user', JSON.stringify(backendUser));
          localStorage.setItem('cuidafast_isLoggedIn', 'true');

          const tipoUsuario = backendUser.tipo || 'cliente';
          if (tipoUsuario === 'cuidador') window.location.href = 'dashboard-cuidador.html';
          else window.location.href = 'homeCliente.html';
        } else {
          console.warn('[callbackGoogleLogin] Backend não retornou user:', result);
          alert('Erro ao fazer login: ' + (result.message || 'Resposta inválida do servidor'));
          window.location.href = '../index.html';
        }

      } catch (err) {
        console.error('[callbackGoogleLogin] Erro inesperado:', err);
        alert('Erro ao processar login. Por favor, tente novamente.');
        window.location.href = '../index.html';
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', processCallback);
    } else {
      processCallback();
    }
  </script>
</body>
</html>
