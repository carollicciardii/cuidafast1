<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Cuidador - CuidaFast</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/icone_verde.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../CSS/styles.css">
    <link rel="stylesheet" href="../CSS/header.css">
    <link rel="stylesheet" href="../CSS/pages/homeCliente.css">
    <style>
        .caregiver-profile-page {
            padding-top: 100px;
            min-height: 100vh;
            background: var(--creme);
        }

        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--azul-escuro);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            gap: 0.75rem;
            color: var(--amarelo-sólido);
        }

        .profile-header {
            background: var(--bege);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
            align-items: start;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--azul-escuro);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 2rem;
            font-weight: 700;
            color: var(--azul-escuro);
            margin-bottom: 0.5rem;
        }

        .profile-specialty {
            font-size: 1.25rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .profile-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .stars {
            color: var(--amarelo-sólido);
            font-size: 1.25rem;
        }

        .rating-text {
            font-size: 1rem;
            color: #666;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .profile-actions .btn.primary {
            background: var(--azul-escuro);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }

        .profile-actions .btn.primary:hover {
            background: var(--azul-escuro-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(27, 71, 93, 0.3);
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .detail-card {
            background: var(--bege);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .detail-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--azul-escuro);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-card h3 i {
            font-size: 1.75rem;
        }

        .detail-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(27, 71, 93, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: var(--azul-escuro);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: #666;
        }

        .bio-text {
            line-height: 1.6;
            color: #666;
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
                align-items: center;
            }

            .profile-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="caregiver-profile-page">
    <!-- Header (igual ao homeCliente) -->
    <header class="modern-header">
        <div class="header-container">
            <!-- Logo Section -->
            <div class="header-left">
                <a href="homeCliente.html" class="logo-link">
                    <img id="logo" src="../assets/Logotipo_1_vetorizado.svg" alt="Logotipo CuidaFast" class="logo" />
                    <span class="logo-text"></span>
                </a>
            </div>
            
            <!-- Search Bar (Desktop) -->
            <div class="header-center">
                <div class="search-container">
                    <i class="ph ph-magnifying-glass search-icon"></i>
                    <input type="text" placeholder="Buscar cuidadores..." class="search-input" id="headerSearch">
                    <button class="search-btn" type="button">
                        <i class="ph ph-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- User Actions -->
            <div class="header-right">
                <!-- Notifications -->
                <button class="header-action-btn notification-btn active" id="notificationBtn">
                    <i class="ph ph-bell"></i>
                    <span class="notification-badge" style="display: none;">0</span>
                </button>
                
                <!-- Messages -->
                <button class="header-action-btn message-btn" id="messageBtn">
                    <i class="ph ph-chat-circle"></i>
                    <span class="message-badge" style="display: none;">0</span>
                </button>
                
                <!-- User Profile -->
                <div class="user-profile-dropdown" id="userProfileDropdown">
                    <button class="user-profile-btn" id="userProfileBtn">
                        <img src="../assets/images.webp" alt="Avatar do usuário" class="user-avatar-img">
                        <span class="user-name" id="headerUserName">Usuário</span>
                        <i class="ph ph-caret-down dropdown-arrow"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div class="profile-dropdown-menu" id="profileDropdownMenu">
                        <div class="dropdown-header">
                            <img src="../assets/images.webp" alt="Avatar" class="dropdown-avatar">
                            <div class="dropdown-user-info">
                                <h4 id="dropdownUserName">Cliente</h4>
                                <p>Conta Cliente</p>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="perfilCliente.html" class="dropdown-item">
                            <i class="ph ph-user"></i>
                            <span>Meu Perfil</span>
                        </a>
                        <a href="../HTML/configuracoes.html" class="dropdown-item">
                            <i class="ph ph-gear"></i>
                            <span>Configurações</span>
                        </a>
                        <a href="homeCliente.html" class="dropdown-item">
                            <i class="ph ph-clock"></i>
                            <span>In-time</span>
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="ph ph-question"></i>
                            <span>Ajuda</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="../../index.html" class="dropdown-item logout-item" id="headerLogoutBtn">
                            <i class="ph ph-sign-out"></i>
                            <span>Sair</span>
                        </a>
                    </div>
                </div>
                
                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="ph ph-list"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Search Bar -->
        <div class="mobile-search-container" id="mobileSearchContainer">
            <div class="mobile-search-wrapper">
                <i class="ph ph-magnifying-glass search-icon"></i>
                <input type="text" placeholder="Buscar cuidadores..." class="mobile-search-input">
                <button class="mobile-search-btn" type="button">
                    <i class="ph ph-arrow-right"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="profile-container">
        <a href="homeCliente.html" class="back-button">
            <i class="ph ph-arrow-left"></i>
            Voltar para busca
        </a>

        <!-- Profile Header -->
        <div class="profile-header">
            <img src="../assets/images.webp" alt="Foto do cuidador" class="profile-avatar" id="caregiverAvatar">
            
            <div class="profile-info">
                <h1 class="profile-name" id="caregiverName">Carregando...</h1>
                <p class="profile-specialty" id="caregiverSpecialty">Especialidade</p>
                
                <div class="profile-rating">
                    <div class="stars" id="caregiverStars">
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                        <i class="ph-fill ph-star"></i>
                    </div>
                    <span class="rating-text" id="caregiverRating">5.0 (0 avaliações)</span>
                </div>

                <div class="profile-actions">
                    <button class="btn primary" id="btnContratar" style="background: var(--azul-escuro); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                        <i class="ph ph-check-circle"></i>
                        Contratar Cuidador
                    </button>
                    <button class="btn primary" id="btnMensagem">
                        <i class="ph ph-chat-circle"></i>
                        Enviar Mensagem
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Details -->
        <div class="profile-details">
            <!-- Sobre -->
            <div class="detail-card">
                <h3>
                    <i class="ph ph-user-circle"></i>
                    Sobre
                </h3>
                <p class="bio-text" id="caregiverBio">Carregando informações...</p>
            </div>

            <!-- Informações de Contato -->
            <div class="detail-card">
                <h3>
                    <i class="ph ph-address-book"></i>
                    Contato
                </h3>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value" id="caregiverEmail">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Telefone</div>
                    <div class="detail-value" id="caregiverPhone">-</div>
                </div>
            </div>

            <!-- Especialidades e Serviços -->
            <div class="detail-card">
                <h3>
                    <i class="ph ph-heartbeat"></i>
                    Especialidades
                </h3>
                <div class="detail-item">
                    <div class="detail-label">Tipo de Serviço</div>
                    <div class="detail-value" id="caregiverTipoServico">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Áreas de Atuação</div>
                    <div class="detail-value" id="caregiverAreasAtuacao">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Valor por Hora</div>
                    <div class="detail-value" id="caregiverValorHora" style="font-weight: 700; color: var(--azul-escuro);">-</div>
                </div>
            </div>

            <!-- Localização -->
            <div class="detail-card" id="locationCard" style="display: none;">
                <h3>
                    <i class="ph ph-map-pin"></i>
                    Localização
                </h3>
                <div class="detail-item">
                    <div class="detail-label">Cidade</div>
                    <div class="detail-value" id="caregiverCity">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value" id="caregiverState">-</div>
                </div>
            </div>
        </div>
    </main>


    <!-- Bootstrap JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Serviços Manager -->
    <script src="../JS/servicosManager.js"></script>
    
    <!-- API de Perfis (SEGURO - Backend) -->
    <script type="module">
        // Importar perfilAPI como módulo ES6
        import * as PerfilAPIModule from '../JS/perfilAPI.js';
        // Tornar disponível globalmente para compatibilidade
        window.PerfilAPIModule = PerfilAPIModule;
    </script>

    <script>
        // Carregar dados do cuidador via API do backend
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar dados do cliente no header
            const clienteData = JSON.parse(localStorage.getItem('cuidafast_user') || '{}');
            
            if (clienteData && clienteData.nome) {
                const primeiroNome = clienteData.primeiroNome || clienteData.nome.split(' ')[0];
                const headerUserName = document.getElementById('headerUserName');
                const dropdownUserName = document.getElementById('dropdownUserName');
                
                if (headerUserName) headerUserName.textContent = primeiroNome;
                if (dropdownUserName) dropdownUserName.textContent = clienteData.nome;
                
                // Atualizar foto do perfil
                if (clienteData.photoURL) {
                    const headerAvatar = document.querySelector('.user-avatar-img');
                    const dropdownAvatar = document.querySelector('.dropdown-avatar');
                    
                    if (headerAvatar) headerAvatar.src = clienteData.photoURL;
                    if (dropdownAvatar) dropdownAvatar.src = clienteData.photoURL;
                }
            }

            // Configurar dropdown menu
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdownMenu = document.getElementById('profileDropdownMenu');
            
            if (userProfileBtn && profileDropdownMenu) {
                userProfileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdownMenu.classList.toggle('show');
                });
                
                document.addEventListener('click', function(e) {
                    if (!userProfileBtn.contains(e.target) && !profileDropdownMenu.contains(e.target)) {
                        profileDropdownMenu.classList.remove('show');
                    }
                });
            }

            // Logout é gerenciado pelo header.js

            // Obter ID do cuidador da URL (fora do try para estar disponível no catch)
            const urlParams = new URLSearchParams(window.location.search);
            const cuidadorId = urlParams.get('id');

            try {
                
                console.log('[PerfilCuidador] URL params:', window.location.search);
                console.log('[PerfilCuidador] ID extraído:', cuidadorId);
                
                if (!cuidadorId) {
                    alert('Cuidador não especificado.');
                    window.location.href = 'homeCliente.html';
                    return;
                }

                // Verificar se PerfilAPIModule está disponível
                console.log('[PerfilCuidador] Verificando PerfilAPIModule:', typeof window.PerfilAPIModule);
                
                const PerfilAPIModule = window.PerfilAPIModule;
                
                if (!PerfilAPIModule || !PerfilAPIModule.buscarPerfilCuidador) {
                    console.error('[PerfilCuidador] PerfilAPIModule não está disponível');
                    console.error('[PerfilCuidador] window.PerfilAPIModule:', window.PerfilAPIModule);
                    alert('Erro: Sistema de perfis não carregado. Recarregue a página.');
                    return;
                }

                // ✅ NOVO: Buscar dados do cuidador via API do backend (SEGURO)
                console.log('[PerfilCuidador] Buscando perfil do cuidador ID:', cuidadorId);
                let caregiver;
                try {
                    caregiver = await PerfilAPIModule.buscarPerfilCuidador(cuidadorId);
                    console.log('[PerfilCuidador] Perfil carregado:', caregiver);
                } catch (apiError) {
                    console.error('[PerfilCuidador] Erro na API:', apiError);
                    // Se falhar com ID, tentar com email
                    if (cuidadorId.includes('@')) {
                        console.log('[PerfilCuidador] Tentando buscar por email:', cuidadorId);
                        caregiver = await PerfilAPIModule.buscarPerfilPorEmail(cuidadorId, 'cuidador');
                        console.log('[PerfilCuidador] Perfil encontrado por email:', caregiver);
                    } else {
                        throw apiError;
                    }
                }
                
                if (!caregiver || !caregiver.nome) {
                    throw new Error('Dados do cuidador inválidos');
                }
                
                console.log('[PerfilCuidador] Perfil carregado com sucesso:', caregiver.nome);
                console.log('[PerfilCuidador] Dados completos do cuidador:', caregiver);

                // ✅ NOVO: Preencher página automaticamente com função auxiliar
                if (PerfilAPIModule.preencherPerfilCuidador) {
                    PerfilAPIModule.preencherPerfilCuidador(caregiver);
                } else {
                    console.warn('[PerfilCuidador] Função preencherPerfilCuidador não encontrada');
                    // Preencher manualmente se a função não estiver disponível
                    const nameEl = document.getElementById('caregiverName');
                    if (nameEl) nameEl.textContent = caregiver.nome || 'Cuidador';
                    
                    const avatarEl = document.getElementById('caregiverAvatar');
                    if (avatarEl && caregiver.foto_perfil) {
                        avatarEl.src = caregiver.foto_perfil;
                    }
                    
                    const bioEl = document.getElementById('caregiverBio');
                    if (bioEl) bioEl.textContent = caregiver.descricao || 'Informações não disponíveis.';
                }
                
                // Dados adicionais que não estão na função auxiliar
                const rating = caregiver.avaliacao || 0;
                const reviews = caregiver.num_avaliacoes || caregiver.numAvaliacoes || caregiver.totalAvaliacoes || 0;
                
                // Atualizar avaliações (sem randomização)
                const ratingElement = document.getElementById('caregiverRating');
                const starsContainer = document.getElementById('caregiverStars');
                
                if (ratingElement && starsContainer) {
                    if (rating > 0 && reviews > 0) {
                        ratingElement.textContent = `${rating.toFixed(1)} (${reviews} avaliação${reviews !== 1 ? 'ões' : ''})`;
                        
                        // Renderizar estrelas
                        const fullStars = Math.floor(rating);
                        const hasHalfStar = rating % 1 >= 0.5;
                        let starsHTML = '';
                        
                        for (let i = 0; i < fullStars; i++) {
                            starsHTML += '<i class="ph-fill ph-star"></i>';
                        }
                        if (hasHalfStar) {
                            starsHTML += '<i class="ph ph-star-half"></i>';
                        }
                        for (let i = Math.ceil(rating); i < 5; i++) {
                            starsHTML += '<i class="ph ph-star"></i>';
                        }
                        starsContainer.innerHTML = starsHTML;
                    } else {
                        // Sem avaliações
                        ratingElement.textContent = 'Sem avaliações';
                        starsContainer.innerHTML = '<i class="ph ph-star"></i><i class="ph ph-star"></i><i class="ph ph-star"></i><i class="ph ph-star"></i><i class="ph ph-star"></i>';
                    }
                }

                // Localização
                if (caregiver.local_trabalho) {
                    const partes = caregiver.local_trabalho.split(',');
                    document.getElementById('locationCard').style.display = 'block';
                    document.getElementById('caregiverCity').textContent = partes[0]?.trim() || '-';
                    document.getElementById('caregiverState').textContent = partes[1]?.trim() || '-';
                }

                // Preencher especialidades (já preenchido pela função preencherPerfilCuidador, mas garantir)
                if (caregiver.tipos_cuidado) {
                    const tiposArray = Array.isArray(caregiver.tipos_cuidado) ? caregiver.tipos_cuidado : [caregiver.tipos_cuidado];
                    const tiposMap = {
                        'idoso': 'Cuidador de Idosos',
                        'pet': 'Cuidador de Pet',
                        'crianca': 'Cuidador Infantil (Babá)',
                        'infantil': 'Cuidador Infantil (Babá)'
                    };
                    const tiposTexto = tiposArray.map(tipo => tiposMap[tipo] || tipo).join(', ');
                    const tipoServicoEl = document.getElementById('caregiverTipoServico');
                    if (tipoServicoEl) tipoServicoEl.textContent = tiposTexto || '-';
                }

                if (caregiver.especialidades) {
                    const areas = Array.isArray(caregiver.especialidades)
                        ? caregiver.especialidades.join(', ')
                        : caregiver.especialidades;
                    const areasEl = document.getElementById('caregiverAreasAtuacao');
                    if (areasEl) areasEl.textContent = areas || '-';
                }

                if (caregiver.valor_hora) {
                    const valorEl = document.getElementById('caregiverValorHora');
                    if (valorEl) {
                        valorEl.textContent = `R$ ${parseFloat(caregiver.valor_hora).toFixed(2).replace('.', ',')}/h`;
                    }
                }

                // Botão Contratar - Redirecionar para contratarInTime
                document.getElementById('btnContratar').addEventListener('click', function() {
                    // Verificar se cliente está logado
                    const clienteData = JSON.parse(localStorage.getItem('cuidafast_user') || '{}');
                    
                    if (!clienteData.email || clienteData.tipo !== 'cliente') {
                        alert('⚠️ Você precisa estar logado como cliente para contratar um cuidador.');
                        window.location.href = '../../index.html';
                        return;
                    }
                    
                    // Salvar ID do cuidador para usar na página de contratação
                    localStorage.setItem('cuidafast_contratacao_cuidadorId', caregiver.id || caregiver.usuario_id || cuidadorId);
                    
                    // Redirecionar para página de contratação
                    window.location.href = 'contratarInTime.html';
                });
                
                // Botão Mensagem - Abrir chat com o cuidador
                document.getElementById('btnMensagem').addEventListener('click', function() {
                    // Verificar se cliente está logado
                    const clienteData = JSON.parse(localStorage.getItem('cuidafast_user') || '{}');
                    
                    if (!clienteData.email || clienteData.tipo !== 'cliente') {
                        alert('⚠️ Você precisa estar logado como cliente para enviar mensagens.');
                        window.location.href = '../../index.html';
                        return;
                    }
                    
                    // Usar ID do cuidador (pode ser número ou email)
                    const destinatarioId = caregiver.id || caregiver.usuario_id || cuidadorId;
                    
                    // Redirecionar para mensagens com o ID do cuidador
                    window.location.href = `mensagens.html?destinatario=${encodeURIComponent(destinatarioId)}`;
                });

            } catch (error) {
                console.error('[PerfilCuidador] Erro ao carregar dados:', error);
                console.error('[PerfilCuidador] Stack trace:', error.stack);
                console.error('[PerfilCuidador] Detalhes do erro:', {
                    message: error.message,
                    name: error.name,
                    cuidadorId: urlParams.get('id')
                });
                
                let errorMessage = 'Erro ao carregar perfil do cuidador.';
                if (error.message) {
                    errorMessage += `\n\nDetalhes: ${error.message}`;
                }
                alert(errorMessage);
                
                // Não redirecionar imediatamente, deixar o usuário ver o erro
                // window.location.href = 'homeCliente.html';
            }
        });
    </script>
    <script src="../JS/header.js"></script>
</body>
</html>
